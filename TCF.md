# PICT - Turbulent Channel Flow

The Turbulent Channel Flow (TCF) is a flow through a periodic channel with walls at the +-y boundaries, which is driven by a forcing in x-direction.

We use this setup to train a neural SGS model that outputs a correcting force such that the statistics of the corrected low-resolution simulation match the reference.

## Setup

### Reference Statistics

Get reference statistics from [here](https://torroja.dmt.upm.es/channels/data/) and place them in `./data/tcf_torroja/`.
The turbulence statistics needed for training are in the file `statistics/Re*/profiles/Re*.prof`.
The optional energy balances are the files `statistics/Re*/balances/Re*.bal.*`

E.g., it should look like this:
```
./data/tcf_torroja/Re550.prof
./data/tcf_torroja/Re550.bal.ww
...
./data/tcf_torroja/Re180.prof
./data/tcf_torroja/Re180.bal.ww
...
```


### Compile Noise Kernels

The TCF uses a Reichardt profile pertubed by curl noise to initialize the velocity field.
PICT provides several kernels for simplex noise expressions that have to be compiled first:
```
cd extensions/noise
python setup_noise.py install
```

## Simulation

The TCF simulation can be run at high resolution to validate PICT against the spectral references. This is quite costly (a resolution of 256 can take several days) and can be skipped if you are only intersted int the SGS learning setup.
The script for pure simulation is `channel_flow_sim.py`. Take a look at the options for simulation time, resolution, and Reynolds number (must match available reference statistics).
To reproduce the results from the paper, run a noise-initialized warm-up for 20ETT. Then load the warmed-up simulation state and simulate another 20ETT to accumulate the statistics.
By default the simulation result will be written to `./test_runs/<time-stamp>_<test-name>/`.


## Dataset

The statistics-based training of the SGS model still needs a set of initial conditions.
These are generated by running a low resolution TCF simulation (64x32x32).

First, creat a warmed-up simulation state by running `channel_flow_sim.py` with the appropriate settings for at least 10 ETT (better 20ETT).  
Then set `save_steps = True`, load the previous simulation state via `load_run_id = "<time-stamp>"`, and simulate at least another 20ETT.
The time stamp (also called 'run-id') are the first 13 characters of the directory name of the simulation.


## Training

Training, inference, and evaluation is done with the script `channel_flow_learning.py`.
To start, set the simulation to be used as initial conditions under DATA: `load_run_id, load_frames = "<time-stamp>", <iterations>`.
The given training intervals correspond to the paper's results. They can be run all at once or individually by loading the (partially) trained model from a previous run via `net_run_id = "<time-stamp>"`.


## Evaluation

To run inference with a trained model, set `eval_only = True` and load the model via `net_run_id = "<time-stamp>"`. Output images and statistics plots will be written as before to `./test_runs/<time-stamp>_<test-name>/`.